\chapter{既往研究の整理}
\label{2}
\section{諸言}\label{2.1}

本章では，各個人の活動需要を予測生成するActivity-based Model(ABM)及び提案手法に使われる機械学習理論について，手法と利用動向を整理し，本研究の位置付けを行う．

本研究では，複数の計算要素の相互関係を，ABMの体系の中でデータ駆動に反映し，施策検討の際にも考慮が可能なABMの開発を目標とする．そのためには，既存のABMが採用している活動需要の生成方法とデータ同化の手法のプログラムの中に，計算要素の相互関係を反映するための機能を内装する必要がある．そのため，初めに2.1節でABMについて整理した後，2.2節以降で計算要素の相互関係を記述，推定する手法についてレビューを行う．

2.2節で取り上げるグラフィカルモデルは，変数間の関係をグラフの形で記述する機械学習モデルであり，グラフ構造を推定することで解釈性や確率計算の速度の面で優れたモデルを構築できる．本モデルはABMでも近年多く採用されており，変数間の関係を明示的に学習することに成功していることから，本研究の目的に合致しつつ利用可能性の高いモデルとしてレビューを行う．

\section{Activity-based Model}\label{2.2}

Activity-based Model(ABM)は，活動の派生需要として移動を捉え，予測・生成するモデルである．交通の需要，配分分析として使われていた四段階推定の限界を克服するものとして研究が始まり，MATSim(Balmer et al., 2004)をはじめとして活動需要の生成から経路への配分まで全てを含むモデルも多く開発されている(Rasouli \& Timmermans, 2014)．一方，研究の中ではモデル改善のため，活動需要を生成するためのモデルを独立して捉えることが多く，近年でも既存ABMの枠組みに新しく開発した活動需要モデルを組み込む研究も多く見られる．本節では活動需要を生成するABMについて，その計算方法と利用法のレビューを行う．

\subsection{モデル分類と計算手法}\label{2.2.1}

活動需要を生成するABMは，その計算方法に基づいて主に３つの分類に区分される．近年ではこれらに加え，機械学習分野のモデルを生成モデルとして用いることで個人の活動需要を生成する研究が現れている．各分類の主な論文とモデルを表２-１に示す．

\begin{enumerate}
	\item 計算プロセス型モデル
	\item 離散選択型モデル
	\item 制約ベースモデル \\
	\item 機械学習分野モデル
\end{enumerate}

一方，Tajaddini et al.(2020)が言及するように，往年の３つのABMは計算プロセス型のヒューリスティクスと離散選択型の確率モデルを組み合わせる形で構成されていることが多いことに注意したい．表\ref{t2}に，ABMの主な計算要素の計算方法として，本表の枠に当てはまるABMが，どの種類を採用しているかを示す．ALBATROSS(Arentze \& Timmermans, 2004)が計算プロセス型，Bowman \& Ben-Akiva(1997)やPCATS(Kitamura \& Fujii, 1998)が離散選択型の典型的な例として挙げられる一方で，TASHA(Miller \& Roorda, 2003)やADAPTS(Auld \& Mohammadian, 2009)はヒューリスティクスに基づく活動生成を行いながらも，部分的に確率モデルの採用を行なっている．確率モデルの採用は，計算プロセス型の課題となっている高計算コストやデータ同化の低再現性を緩和しうる拡張である．また，こうした計算方法の自由度は機械学習分野モデルの利用によっても向上している．

\begin{table}[bp]
	\begin{center}
		\caption{各計算要素の計算方法に基づくABMの分類}
		\label{t2}
		\begin{tabular}{l|rr} 
			計算要素 & 確率モデル & ヒューリスティクス \\ \hline
			活動パターン生成 & CEMDAP, ADAPTS, & ALBATROSS, TASHA \\
			 & Bowman \& Ben-Akiva, PCATS & \\
			継続時間，開始時間決定 & CEMDAP, Bowman \& Ben-Akiva, PCATS & ALBATROSS, TASHA, ADAPTS \\
			目的地選択 & CEMDAP, Bowman \& Ben-Akiva,& ALBATROSS \\
			 &  PCATS, TASHA, ADAPTS & \\
			交通手段選択 & CEMDAP, Bowman \& Ben-Akiva, & ALBATROSS \\
			 & PCATS, TASHA, ADAPTS & \\ 
		\end{tabular}
	\end{center}
\end{table}

これを踏まえ，各分類の計算方法について整理する．

\subsubsection{計算プロセス型}

計算プロセス型は，ある規則に基づいて生成する活動の特徴を決定する計算プロセスを組み合わせたモデルである．活動生成の際の規則はヒューリスティクスに基づいて提案されており，個人の意思決定を模倣する計算プロセスが構成されている．

包括的な計算プロセス型モデルとして，ALBATROSS(Arentze \& Timmermans, 2004)が初めに挙げられる．ALBATROSの活動生成手順を図２-１に示した．ALBATROSでは，スケジュールの枠に対して，優先度順に活動を追加していくことで１日のスケジュールを生成する．その際，図２-１のように活動の各要素(継続時間，開始時刻，移動手段，活動場所)を順に，制約に基づいて実行可能な選択集合からサンプリングすることで決定していく．計算プロセスは重要な活動・要素から決定していくという意思決定を模倣するヒューリスティクスに基づいており，計算プロセス型モデルを特徴付ける点である．その一方で，実行可能な集合の作成と，集合からのサンプリングには決定木が用いられている．決定木は個人特性やスケジュール，時空間制約を入力として，活動の各要素についての選択結果を出力とする．このように，計算プロセス型のモデルでも，確率的な選択をモデル化するため，またはデータ同化のために確率モデルを部分的に採用している．

計算プロセス型モデルの中で，より確率モデルを取り入れたモデルとして，TASHA(Miller \& Roorda, 2003)が挙げられる．TASHAの計算プロセスを簡易的に示した図２-２の中で，活動場所と移動手段の選択において，離散選択型モデルで採用されるモデルが用いられている．活動の頻度や開始時刻，継続時間といった特徴も初めの計算プロセスで分布からサンプリングすることで生成しており，よりデータ同化を行いやすい．これら確率モデルでサンプリングされた活動をスケジュールの時間制約内に当てはめることで1日のスケジュールを生成しており，本モデル内においてヒューリスティクスは「個人のスケジュールが実現可能なものである」ことを保証するために用いられている．

\subsubsection{離散選択型モデル}

離散選択型のモデルは，個人が効用の最大化を達成する選択を行うという仮定の元，活動パターンを選択肢集合の中から生成するモデルである．

離散選択型モデルの構造は，Multinomial Logit Model(MNLモデル)をはじめとする離散選択モデルを拡張することで得られており，各個人の効用を，特徴量と推定パラメータから構成される確定項と特定の分布に従うランダム項に分解して表現する．MNLモデルはランダム項が相関のないロジット分布に従うと仮定するモデルであり，線形モデルにより選択肢$i \in I$の効用の確定項$V_{i}$は式(\ref{eq2_1})，選択確率$P_{i}$は式(\ref{eq2_2})として表される．Bowman \& Ben-Akiva (2001)は誤差相関を加味したNested Logit Model(NLモデル)を用いて，離散選択モデルに基づくABSを開発した．式(\ref{eq2_3})を例とする入子状の効用関数により，活動を評価する関数を

\begin{enumerate}
	\item 活動パターン
	\item 主活動の開始時刻
	\item 主活動の活動場所と移動手段
	\item 従属活動の開始時刻
	\item 従属活動の活動場所と移動手段
\end{enumerate}

の５段階の入れ子で表現した．$\Lambda_{i}$は$j \in J$に関する下位選択モデルのログサム変数であり，$i \in I$に関する上位選択モデルに，そのスケールパラメータ$ \lambda$の大きさに応じた影響を与える．活動パターンはスケジュールを用いる計算プロセス型モデルのスケジュールに相当し，主活動の目的と従属活動の回数・目的，活動を行う場所(home, work, other)の順列から成る．

\begin{equation} \label{eq2_1}
	V_{i} = \bm{\beta} \cdot \bm{x_{i}}
\end{equation}

\begin{equation} \label{eq2_2}
	P_{i} = \frac{\exp(V_{i})}{\sum_{i^{'} \in I} \exp(V_{i^{'}})}
\end{equation}

\begin{equation} \label{eq2_3}
	\begin{split}
		V_{i} &= \bm{\beta} \cdot \bm{x_{i}} + \lambda  \Lambda_{i}\\
		\Lambda_{i} &= ln \sum_{j^{'}}\exp(V_{i,j^{'}})
	\end{split}
\end{equation}


	
離散選択型のモデルでは，活動の各要素について効用を表現する関数を定義することが多いが，Kitamura \& Fujii (1998)のPCATSでは，スケジュール中の$n$個目の活動の活動目的$X_n$・継続時間$D_n$・活動場所$L_n$・移動手段$M_n$についての同時確率として定式化し，活動を生成することを目的としている．$k$個の活動から成る1日のスケジュールを生成するための確率を，式(\ref{eq2_4})のように分解することで，確率の推定や活動のサンプリングを行なっている．逐次的に活動をサンプルする方法により，時空間制約の中で妥当な活動列を生成することに成功している．一方で同研究により開発された実際のモデルでは，式(\ref{eq2_5})を例として同時確率を分解して考えており，最終的にはNLモデルと同様に条件付き確率の計算により，同時確率の計算を置き換えている．

\begin{equation} \label{eq2_4}
	\Pr[\bm{X, D, L, M}] = \prod_{i=0}^{k-1} \Pr[X_{i+1}, D_{i+1}, L_{i+1}, M_{i+1} | \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}]
\end{equation}

\begin{equation} \label{eq2_5}
	\begin{split}
		\Pr&[X_{i+1}, D_{i+1}, L_{i+1}, M_{i+1} | \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}] \\
		= &\Pr[X_{i+1} | \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}] \times  \Pr[D_{i+1} | X_{i+1}; \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}] \\
		\times &\Pr[L_{i+1} | X_{i+1}, D_{i+1}; \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}] \times \Pr[M_{i+1} | X_{i+1}, D_{i+1}, L_{i+1}; \tilde{X}_{i}, \tilde{D}_{i}, \tilde{L}_{i}, \tilde{M}_{i}]
	\end{split}
\end{equation}


\subsubsection{制約ベースモデル}

制約ベースモデルはABMの中でも初期に開発されたモデルである．本モデルは上記の2つのモデルとは異なり，個人のスケジュールを出力ではなく入力としている．入力として受け取った個人のスケジュールが，与えられた交通ネットワークと時空間制約の元で，実行可能であるかを判断するモデルである．近年の研究としても，活動を生成するモデルの開発ではなく，個人間相互作用の記述(Farber et al. 2013)や選択肢集合の定義への活用(Arentze \& Timmermans, 2000)といった時空間制約の拡張が行われている．

\subsubsection{機械学習分野モデル}

近年では，機械学習分野のモデルをABMとして活用した活動生成が研究されている．計算プロセス型や離散選択型に分類されるモデルでも，AMOS(Kitamura et al., 1993)やALBATROS(Arentze \& Timmermans, 2004)など機械学習モデルを一部組み込んだABMは多く提案されてきた．一方，近年では機械学習モデル単体で活動生成を行うモデルの開発がされている．

2010年代初期から今日まで，ABMでの活用が続くモデルが，Bayesian Network(BN)である．BNは変数間の因果関係を非循環有効グラフ(DAG)の構造で表現する，グラフを用いた確率モデルの一種である．Ma(2015)やMa et al.(2017)はBNのグラフ構造を推定することで，交通モード選択の際の意思決定構造を明らかにした．その後，Joubert \& Waal(2020)やWaal \& Joubert(2022)はBNを用いたABMを開発し，説明可能性の高いモデルの構築を試みている．一方で，多変数・多ラベルから成るBNの構造をデータから学習することは大きな計算コストを要し，ABM分野の研究でも限られた変数に対してのグラフ構造の学習が行われており，選択肢集合の多い目的地選択などは行われていない．

機械学習分野のモデルとして，近年利用が多い深層学習モデルの利用も行われている．Chiesa \& Taraglio(2022)はVariational Auto Encoder(VAE)を用いて活動需要の生成を行なっている．こうした深層生成モデルの利用は，ABMの入力となる人口を生成するためのPopulation Synthesis分野でも行われており(Stanislav et al., 2019)，活動に関する観測データの増加に伴い大きな発展が期待される．

\subsection{交通需要制御とモデル検証}\label{2.2.2}

ABMの主な開発目標の一つに，モデルを用いた交通需要制御(TDM)が挙げられる．近年ではMATSimをはじめとする開発済みABMを用い，様々な交通施策について検証が行われている(Tajaddini et al., 2020)．多くの研究で検証されているシェアモビリティや駐車場導入・混雑課金をはじめとし，近年ではCOVID-19の影響(Alam et al., 2022)の検証にもABMが用いられている．利用されているモデルとしては，交通量配分モデルと接続しているMATSimが利用されることが多い一方，特定の検証目的に即した他の計算プロセス型や離散選択型モデルも適用されている．

こうしたABMを用いたTDMの検証では，交通施策を導入した後の各指標の変化を計算することにより，TDMの評価を行う．同じシェアモビリティの検討でも，Cuaru et al.(2013)では導入後のシェアモビリティ利用数を検証しているのに対して，Becker et al.(2020)は異なる車両サイズによってもたらさせれる福祉的影響(移動時間や一般化コスト・消費エネルギー)を評価している．また，Balac et al.(2017)はフリーフロート型のシェアモビリティの導入をMATSimにより行い，利用率についての検証を行なっている．これら多様な指標の計算が可能な点は，個人の活動需要を考慮するABMの，特に交通量配分モデルと接続することの用意なMATSimの利点である．駐車場導入でも同様に，Benenson et al.(2008)が駐車場密度による駐車場探索時間への影響を計算プロセス型のモデルで評価した一方，Waraich \& Axhausen(2012)は離散選択型モデルを用いて駐車場密度や容量・料金が及ぼす自動車利用と道路混雑への影響と，多様な検証が行われている．

その一方で，検証に用いられているABM自体も，その精度やパラメータの感度といった項目で検証の対象となっている．Khan et al.(2022)は土地利用を組み込んだABMに対して，通勤開始時間・通勤距離・通勤手段・活動種類割合といった多数の予測項目について検証を行ない，モデルがTDMの検証を行うに足る精度を持つことを示した．感度については，Zhuge et al.(2019)が繰返し計算回数や計算時間幅といったMATSimのハイパーパラメータに対して検証を行なっており，これらの設定によって大きく計算結果が変化することを示している．また，yang et al.(2013)は感度分析を通して，パラメータの変化(不確実性)がABMの出力に大きな影響を与えることを示唆した．

\subsection{要素間相互関係}\label{2.2.3}

\ref{2.2.2}では，近年行われているABMによるTDMの検証について，その研究の潮流と利点を述べた．一方で，MATSimを用いて交通手段の転換を検証する研究でも，Adnan et al.(2020)をはじめとして，TDMの検証を行う際の指標は一つの計算要素内で留まるものが多い．複数の計算要素(又は意思決定)が互いに与える影響をABMで考慮する際には，明示的に相互関係をモデル内に導入する方法と，繰返し計算により相互関係がシミュレーション出力に反映する方法とが用いられる．以下では，計算要素間の相互関係を考慮する手法と，それらが用いられる状況について整理する．  

\subsubsection{明示的な相互関係導入}
離散選択型のモデルでは，MNLモデルの拡張により複数の計算要素間に相互関係を明示的に導入することが行われている．

Bowman \& Ben-Akiva(1997)をはじめとした離散選択型モデルは，Nested Logit モデル(NLモデル)と同様の離散選択モデルを導入することで，計算要素の相互作用を考慮している．下位の意思決定に用いられる離散選択モデルのlogsum値を，上位の離散選択モデルに変数として追加することで，上位の意思決定を行う際に下位の意思決定結果を反映さする方法である．具体的なモデルの選択確率を式(\ref{eq2_6})，(\ref{eq2_7})と(\ref{eq2_8})に記す．式(\ref{eq2_6})で示す$\tilde{V}_{m}$は下位の離散選択モデルによる効用の確定項から成るログサムである．$M$についてのログサム値を(\ref{eq2_7})のように$D$に関しての上位の離散選択モデルの変数の一つとして用いることで，上位の意思決定時に下位の意思決定によって得られる効用を考慮することができる．式(\ref{eq2_8})は選択肢$(d,m)$を同時に選択する確率であり，$M$が与えられた時の$D$の条件付き確率を考慮することで意思決定の相互関係をモデル化する．

\begin{equation} \label{eq2_6}
	\tilde{V}_{m} = \frac{1}{\mu_m} \ln \left( \sum_{m' \in M} \exp (\mu_m V_{m'}) \right)
\end{equation}

\begin{equation} \label{eq2_7}
	V'_d = V_d + \sum \tilde{V}_m
\end{equation}

\begin{equation} \label{eq2_8}
	P(d,m) = P(d|m)P(m) = \frac{\exp(\mu_m V'_d)}{\sum_{d' \in D} \exp(\mu_m V'_{d'})} \times \frac{\exp(\mu_m \tilde{V}_{m})}{\sum_{m' \in M} \exp(\mu_m \tilde{V}_{m'})}
\end{equation}

他モデルのログサム値を他モデルの変数として用いる手法は，NLモデルからの拡張として広く適用されている．Ho \& Mulley(2013)では活動ツアーパターン選択に交通手段選択のログサム変数を導入することで，交通手段選択が家庭環境に大きく依存する休日の活動において，活動ツアーパターンが交通手段により強い制約を受けていることを明らかにした．また，Khan et al.(2022)は要素を説明するためのモデルを複数構築した後，ログサム値を用いるフィードバックをABMに導入することで，交通手段の選択による実施可能な活動種類への影響をモデルに導入した．いずれも，分析対象の計算要素に離散選択モデルを構築し，一方のログサム値を他方の変数として用いることで計算要素間の関係を記述している．

\subsubsection{繰返し計算}
MATSim(Balmer et al., 2004)は，活動需要予測を行うABMとネットワーク上の配分計算を行うモデルの両方を包含しており，繰り返し計算を行いネットワーク条件を更新することで計算要素の相互関係を記述することが可能である．MATSimで用いられる繰返し計算の流れを，図\ref{pic2_3}に示す．MATSimでは，ABMで生成された活動需要から，mobsimというネットワーク配分モデルを用いてネットワークの状態を計算する．ネットワーク状態に基づき，ABMで生成された活動(1日のスケジュール)をスコア化し，スコアが収束するまでABMでの活動需要生成を繰返す(Nagel et al., 2016)．

繰返し計算は，ネットワーク状態を考慮した現実的なスケジュールを生成する目的で導入される一方で，計算要素間が持つ相互関係のモデル化にも貢献している．Dobler(2009)は繰返し計算によって個人が行うスケジュールの見直しを表現し，意思決定時に他の計算要素を考慮するアルゴリズムを提案した．また，Maheshwari et al.(2023)が交通基盤と都市の発展が相互に及ぼす影響を分析したように，決まった複数の現象間の相互関係を繰返し計算でシミュレーションに反映する研究も見られる．




\section{グラフィカルモデル}\label{2.3}

\subsection{グラフィカルモデル}\label{2.3.1}

\subsection{構造の学習手法}\label{2.3.2}